<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" media="screen" href="assets/css/bootstrap.min.css?v=3.3.6">
    <link rel="stylesheet" type="text/css" media="screen" href="assets/css/jquery.flex-images.css">
    <link rel="stylesheet" type="text/css" media="screen" href="assets/css/index.css">
    <script src="assets/js/jquery-3.3.1.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/jquery.flex-images.min.js"></script>
    <script src="assets/js/piexif.js"></script>
    <script src="assets/js/localResizeIMG.js"></script>
</head>
<style type="text/css">
    body {
        padding-top: 60px;
    }

    #imgFlow img:hover {
        border: 1px solid red;
    }

    .t {
        width: 700px;
        overflow: hidden;
    }

    .divtd {
        height: 30px;
        overflow: hidden;
    }


    .th {
        overflow: hidden;
    }

    .te {
        width: 350px;
        height: 30px;
        overflow: hidden;
    }

    .originalImage {
        max-width: 300px;
        height: auto;
    }
</style>
<body>
<input id="pictures" type="file" webkitdirectory name="jpg" size="30" style="display:none"/>
<div id="message"></div>
<div class="container">
    <div class="row">
        <div class="col-lg-6 col-lg-offset-3">
            <button type="button" class="btn btn-default" onclick="$('input[id=pictures]').click();">选择文件夹</button>
            <button type="button" class="btn btn-default" onclick="flexImg()">（默认样式）Default</button>
        </div>
    </div>
    <div class="row">
        <div class="pre-scrollable col-lg-10 col-lg-offset-1" style="height: 800px;margin-top: 35px">
            <div class="flex-images" id="imgFlow">
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">Modal title</h4>
            </div>
            <div class="image-bg"></div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="panel panel-default" id="output">
                            <!-- Default panel contents -->
                            <div class="panel-heading">Exif</div>
                            <table class="table">
                                <thead>
                                <tr>
                                    <th>属性</th>
                                    <th>First Name</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td>DateTimeOriginal</td>
                                    <td>
                                        <input type="text" class="form-control" value="2010%3A10%3A10%2010%3A10%3A10"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Sharpness</td>
                                    <td>
                                        <input type="text" class="form-control" value="777"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>LensSpecification</td>
                                    <td>
                                        <input type="text" class="form-control" value="[[1,1],[1,1],[1,1],[1,1]]"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>LensMake</td>
                                    <td>
                                        <input type="text" class="form-control" value="KJisss"/>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary">重置</button>
                <button type="button" class="btn btn-success">提交</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="loading">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            ...
        </div>
    </div>
</div>
<script>
    var files;

    function flexImg() {
        $('#imgFlow').flexImages({rowHeight: 100});
    }

    function openDetail(index) {
        $("#output").empty();
        //根据索引取出原始文件,读取exif信息
        let file = files[index];
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function (e1) {
            var dataURL = e1.target.result;
            printExif(dataURL);
            console.log("读取" + file.name);
        };
        $('#detailModal').modal({
            // backdrop: 'static',
            // keyboard: false
            // remote: '/modify.html'

        })
    }

    $('#detailModal').on('hidden.bs.modal', function (e) {

    });


    function loadHeaderBg(url) {
        $(".modal-header").css("background", "url(" + url + ") center center no-repeat");
        $(".modal-header").css("background-size", "100% auto");
    }

    $("#pictures").change(function (e) {
        $('#photoCover').val($(this).val());
        files = e.target.files;
        if (files.length > 1000) {
            alert("请选择少于1000张图片的文件夹");
            $(this).val("")
            return;
        }
        $(files).each(function (index, item) {
            var file = e.target.files[index];
            $(file).localResizeIMG({
                width: 200,
                quality: 0.8,
                success: function (result) {
                    var img = new Image();
                    img.src = result.base64;
                    img.onload = function () {
                        var w = img.width;
                        var h = img.height;
                        var im = $(img).attr("onclick", "openDetail(" + index + ")").attr("img-index", index).attr("img-name", file.name);
                        let flow_div = $('<div class="item" data-w="' + w + '" data-h="' + h + '"></div>');
                        $("#imgFlow").append($(flow_div).append(im));
                    };
                    console.log(result);
                }
            });
        });
    });

    /*打印exif信息*/
    function printExif(dataURL) {
        var originalImg = new Image();
        originalImg.src = dataURL;

        //加载背景图
        loadHeaderBg(dataURL);

        var exif = piexif.load(dataURL);
        var ifds = ["0th", "Exif", "GPS", "Interop", "1st"];
        var s = ""
        for (var i = 0; i < 5; i++) {
            var ifd = ifds[i];
            var ifd_i = "";
            for (var tag in exif[ifd]) {
                var str;
                if (exif[ifd][tag] instanceof Array) {
                    str = JSON.stringify(exif[ifd][tag]);
                } else {
                    str = escape(exif[ifd][tag]);
                }
                ifd_i += ("<tr><td class='te'>" + piexif.TAGS[ifd][tag]["name"] +
                    "</td><td class='te'><div>" +
                    str + "</div></td></tr>");
                console.log(str);
            }
            s += ("<table class='table'><tr><th colspan='2'>" +
                ifd + "</th></tr>" + ifd_i + "</table>");
        }
        // if (exif["thumbnail"]) {
        //     var thumbStr = "data:image/jpeg;base64," + btoa(exif["thumbnail"]);
        //     //$("#imgFlow").append('<div class="item" data-w="170" data-h="150"><img src="'+thumbStr+'"></div>');
        //     var img = "<img src='{img}'></img>".replace("{img}", thumbStr);
        //     s += ("<table class='t'><tr><th class='th'>thumbnail</th></tr><tr><td>" +
        //         img + "</td></tr></table><br>");
        // }
        var newDiv = $("<div class='z'></div>").html(s).hide();

        $("#output").prepend(newDiv);

        originalImg.onload = function () {
            var w = originalImg.width;
            var h = originalImg.height;
            var size = $("<div></div>").text("Original size:" + w + "*" + h);
            var im = $(originalImg).addClass("originalImage");
            // newDiv.prepend(im);
            // newDiv.prepend(size);
        }
        // newDiv.slideDown(2000);
        newDiv.show();
    }

    function handleFileSelect(evt) {
        var file = evt.target.files[0];
        var reader = new FileReader();
        reader.onloadend = function (e) {
            printExif(e.target.result);
        };
        reader.readAsDataURL(file);
    }

    document.getElementById('f').addEventListener('change', handleFileSelect, false);

    /*生成缩略图预览图片*/
    function thumbnail(file) {
        let z = new zz();
        z.compressPhotoUpload({
            file: file, //必传，上传图片
            ratio: 0.1, //默认为0.1   压缩比
            maxsize: 1, //默认为1024,单位为kb    大于此值则做压缩操作
            success: (e) => { //必传，成功后的回调函数，返回的参数是图片信息（对象）
                console.log(e);
                return e.data;
                //document.querySelector("body").innerHTML = `<a href="${}"  download><img id="img" src="${e.data}" width="200px"/></a>`
            }
        });
    }
</script>
</body>
</html>