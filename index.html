<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>照片Exif信息查看&修改</title>
    <link rel="stylesheet" type="text/css" media="screen" href="assets/css/bootstrap.min.css?v=3.3.6">
    <link rel="stylesheet" type="text/css" media="screen" href="assets/css/jquery.flex-images.css">
    <link rel="stylesheet" type="text/css" media="screen" href="assets/css/index.css">
    <script src="assets/js/jquery-3.3.1.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/jquery.flex-images.min.js"></script>
    <script src="assets/js/piexif.js"></script>
    <script src="assets/js/localResizeIMG.js"></script>
</head>
<style type="text/css">
    body {
        padding-top: 60px;
    }

    #imgFlow img:hover {
        border: 1px solid red;
    }

    .t {
        width: 700px;
        overflow: hidden;
    }

    .divtd {
        height: 30px;
        overflow: hidden;
    }


    .th {
        overflow: hidden;
    }

    .te {
        width: 350px;
        height: 30px;
        overflow: hidden;
    }

    .originalImage {
        max-width: 300px;
        height: auto;
    }
</style>
<body>
<input id="pictures" type="file" webkitdirectory name="jpg" size="30" style="display:none" accept="image/jpeg"/>
<div id="message"></div>
<div class="container">
    <div class="row">
        <div class="col-lg-4 col-lg-offset-4">
            <button type="button" class="btn btn-default btn-block" onclick="$('input[id=pictures]').click();">选择文件夹
            </button>
        </div>
    </div>
    <div class="row">
        <div class="pre-scrollable col-lg-10 col-lg-offset-1" style="height: 800px;margin-top: 35px">
            <div class="flex-images" id="imgFlow">
                <div class="welcome">
                    <h3>请选择文件夹预览图片</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-10 col-lg-offset-1 foot">
            <p>声明</p>
            <p>
                使用开源库&nbsp;
                <a href="https://github.com/hMatoba/piexifjs" target="_blank">piexifjs</a>&nbsp;
                <a href="https://github.com/twbs/bootstrap" target="_blank">BootStrap</a>&nbsp;
            </p>
            <p>
                author&nbsp; <a>ws</a>&nbsp;
                <a href="https://github.com/kingwsi/photo-exif" target="_blank">https://github.com/kingwsi/photo-exif</a>
            </p>
        </div>
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">Modal title</h4>
            </div>
            <div class="image-bg"></div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="panel panel-default" id="output">

                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary">重置</button>
                <button type="button" class="btn btn-success">提交</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="loading" id="loading">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="progress">
                <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="89"
                     aria-valuemin="0" aria-valuemax="100" style="width: 45%">
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var files;

    function flexImg() {
        $('#imgFlow').flexImages({rowHeight: 100});
    }

    function loading(ratio) {
        $(".progress-bar").attr("aria-valuenow", ratio).attr("style", "width: " + ratio + "%");
    }

    function openDetail(index) {
        $("#output").empty();
        //根据索引取出原始文件,读取exif信息
        let file = files[index];
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function (e1) {
            var dataURL = e1.target.result;
            printExif(dataURL);
            console.log("读取" + file.name);
        };
        $('#detailModal').modal({
            // backdrop: 'static',
            // keyboard: false
            // remote: '/modify.html'

        })
    }

    $('#detailModal').on('hidden.bs.modal', function (e) {

    });

    function loadHeaderBg(url) {
        $(".modal-header").css("background", "url(" + url + ") center center no-repeat");
        $(".modal-header").css("background-size", "100% auto");
    }

    $("#pictures").change(function (e) {
        files = e.target.files;
        if (files.length > 1000) {
            alert("请选择少于1000张图片的文件夹");
            $(this).val("");
            return;
        }
        $('#imgFlow').empty();
        /*加载进度条*/
        $(".progress-bar").attr("style", "width: 0%");
        $('#loading').modal();
        var count = 1;
        var length = files.length;
        $(files).each(function (index, item) {
            var file = e.target.files[index];
            let fileFormat = file.name.substring(file.name.lastIndexOf(".")).toLowerCase();
            if (!fileFormat.match(/.png|.jpg|.jpeg|.gif/)) {
                length--;
                console.log(length);
            }
            $(file).localResizeIMG({
                width: 200,
                quality: 0.8,
                success: function (result) {
                    var img = new Image();
                    img.src = result.base64;
                    img.onload = function () {
                        var w = img.width;
                        var h = img.height;
                        var im = $(img).attr("onclick", "openDetail(" + index + ")").attr("img-index", index).attr("img-name", file.name);
                        let flow_div = $('<div class="item" data-w="' + w + '" data-h="' + h + '"></div>');
                        $("#imgFlow").append($(flow_div).append(im));
                        var ratio = (count++ / length).toFixed(2);
                        loading(ratio * 100);
                        console.log(ratio);
                        if (ratio == 1) {
                            flexImg();
                            $('#loading').modal('hide')
                        }
                    };
                }
            });
        });
    });

    /*打印exif信息*/
    function printExif(dataURL) {
        var originalImg = new Image();
        originalImg.src = dataURL;

        //加载背景图
        loadHeaderBg(dataURL);

        var exif = piexif.load(dataURL);
        var ifds = ["0th", "Exif", "GPS", "Interop", "1st"];
        var s = ""
        for (var i = 0; i < 5; i++) {
            var ifd = ifds[i];
            var ifd_i = "";
            for (var tag in exif[ifd]) {
                var str;
                if (exif[ifd][tag] instanceof Array) {
                    str = JSON.stringify(exif[ifd][tag]);
                } else {
                    str = escape(exif[ifd][tag]);
                }
                ifd_i += ("<tr><td class='te'>" + piexif.TAGS[ifd][tag]["name"] +
                    "</td><td class='te'><div>" +
                    str + "</div></td></tr>");
                console.log(str);
            }
            s += ("<table class='table'><tr><th colspan='2'>" +
                ifd + "</th></tr>" + ifd_i + "</table>");
        }
        // if (exif["thumbnail"]) {
        //     var thumbStr = "data:image/jpeg;base64," + btoa(exif["thumbnail"]);
        //     //$("#imgFlow").append('<div class="item" data-w="170" data-h="150"><img src="'+thumbStr+'"></div>');
        //     var img = "<img src='{img}'></img>".replace("{img}", thumbStr);
        //     s += ("<table class='t'><tr><th class='th'>thumbnail</th></tr><tr><td>" +
        //         img + "</td></tr></table><br>");
        // }
        var newDiv = $("<div class='z'></div>").html(s).hide();

        $("#output").prepend(newDiv);

        originalImg.onload = function () {
            var w = originalImg.width;
            var h = originalImg.height;
            var size = $("<div></div>").text("Original size:" + w + "*" + h);
            var im = $(originalImg).addClass("originalImage");
            // newDiv.prepend(im);
            // newDiv.prepend(size);
        }
        // newDiv.slideDown(2000);
        newDiv.show();
    }
</script>
</body>
</html>